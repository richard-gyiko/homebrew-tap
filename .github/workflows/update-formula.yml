name: Update Formula

on:
  workflow_dispatch:
    inputs:
      formula:
        description: 'Formula name (without .rb)'
        required: true
        type: string
      version:
        description: 'Version (without v prefix)'
        required: true
        type: string
      sha256_mac_arm:
        description: 'SHA256 for macOS ARM (aarch64)'
        required: false
        type: string
      sha256_mac_x64:
        description: 'SHA256 for macOS x64'
        required: false
        type: string
      sha256_linux:
        description: 'SHA256 for Linux x64'
        required: false
        type: string

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Update formula
        run: |
          FORMULA="Formula/${{ inputs.formula }}.rb"
          VERSION="${{ inputs.version }}"
          
          # Update version
          sed -i "s/version \".*\"/version \"$VERSION\"/" "$FORMULA"
          
          # Update URLs (replace version in download URLs - handles both cli/vX.X.X and vX.X.X formats)
          sed -i "s|/download/cli/v[0-9.]*|/download/cli/v$VERSION|g" "$FORMULA"
          sed -i "s|/download/v[0-9.]*-\?[a-z0-9]*/|/download/v$VERSION/|g" "$FORMULA"
          
          # Update hashes if provided
          if [ -n "${{ inputs.sha256_mac_arm }}" ]; then
            # Find the aarch64-apple-darwin block and update its sha256
            sed -i "/aarch64-apple-darwin/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${{ inputs.sha256_mac_arm }}\"/}" "$FORMULA"
          fi
          
          if [ -n "${{ inputs.sha256_mac_x64 }}" ]; then
            # Find the x86_64-apple-darwin block and update its sha256
            sed -i "/x86_64-apple-darwin/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${{ inputs.sha256_mac_x64 }}\"/}" "$FORMULA"
          fi
          
          if [ -n "${{ inputs.sha256_linux }}" ]; then
            # Find the on_linux block and update its sha256
            sed -i "/on_linux/,/sha256/{s/sha256 \"[a-f0-9]*\"/sha256 \"${{ inputs.sha256_linux }}\"/}" "$FORMULA"
          fi

      - name: Commit and push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git diff --staged --quiet || git commit -m "Update ${{ inputs.formula }} to v${{ inputs.version }}"
          git push
